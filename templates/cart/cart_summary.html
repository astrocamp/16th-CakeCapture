{% extends 'shared/base.html' %}
{% block content %}

<!-- container -->
<div class="mt-28 w-screen max-w-screen-2xl mx-auto">
    <!-- section-title -->
    <div class="m-2 p-2 text-2xl font-semibold">
        <p>親愛的會員 ID 您好</p>
    </div>
    <!-- section-order -->
    <div class="mt-12 m-2 p-2 text-center">
        <!-- order-tag -->
        <!-- <div class="flex text-xl font-semibold">
            <div class="w-60 rounded-t-xl p-2 bg-red-300 text-white">
                <h3>購物明細</h3>
            </div>
            {% comment %} <div class="w-60 rounded-t-xl p-2 bg-white border-2 border-red-300 text-red-400">
                <h3>免費贈品</h3>
            </div> {% endcomment %}
            {% comment %} <div class="w-60 rounded-t-xl p-2 bg-white border-2 border-red-300 text-red-400">
                <h3>點數回饋</h3>
            </div> {% endcomment %}
            {% comment %} <div class="w-60 rounded-t-xl p-2 bg-white border-2 border-red-300 text-red-400">
                <h3>下次再買清單</h3>

            </div>
        </div> 

            </div> {% endcomment %}
        </div>

        <span class="block w-full h-1 bg-red-300"></span>
        <!-- order-header -->
        <div class="flex mt-2 p-2 bg-red-200 text-xl font-semibold rounded-xl">
            <div class="w-1/12 p-2 text-center">
                <input type="checkbox" class="block m-auto w-7 h-7 p-2" id="firstcb">
            </div>
            <div class="w-1/3 p-2 border-l-2 border-red-400">
                <p>商品明細</p>
            </div>
            <div class="w-1/6 p-2 border-l-2 border-red-400">
                <p>類別</p>
            </div>
            <div class="w-1/12 p-2 border-l-2 border-red-400">
                <p>數量</p>
            </div>
            <div class="w-1/12 p-2 border-l-2 border-red-400">
                <p>金額</p>
            </div>
            <div class="w-1/12 p-2 border-l-2 border-red-400">
                <p>庫存</p>
            </div>
            <div class="w-1/6 p-2 border-l-2 border-red-400">
                <p>變更明細</p>
            </div>
        </div>
        <!-- order-list -->
        {% for product in cart_products %}
        <div class="flex mt-2 p-2 h-52 rounded-xl text-xl border-2 border-red-300 cake" data-product-id="{{product.id}}">
            <div class="w-1/12 felx flex-col m-auto">
                <input type="checkbox" class="w-7 h-7 m-auto p-2 cb">
            </div>
            <div class="flex w-1/3 p-2">
                <div class="product-img rounded-2xl w-[180px] h-[180px] overflow-hidden">
                    <img src="{{product.image.url}}" alt="#" class="w-full h-full object-cover">
                </div>
                <div class="felx flex-col m-auto w-1/2 p-2">
                    <p>{{product.name}}</p>
                </div>
            </div>
            <div class="felx flex-col m-auto w-1/6 p-2">
                <p>{{product.category}}</p>
            </div>
            <div class="felx flex-col m-auto w-1/12 p-2">
                {% for key, value in quantities.items%}
                {% if key == product.id|slugify %}
                <input type="number" min="1" value="{{ value }}"
                    class="w-24 px-2 py-1 border border-black rounded-lg appearance-none update"
                    data-index="{{product.id}}">
                {% endif %}
                {% endfor%}

            </div>
            <div class="felx flex-col m-auto w-1/12 p-2">
                <p>$ {{product.price}}</p>
            </div>
            <div class="felx flex-col m-auto w-1/12 p-2">
                <p>庫存剩餘：{{product.quantity}}</p>
            </div>
            <div class="felx flex-col m-auto w-1/6 p-2">

                <div class="m-2 p-2">
                    <a href="#" class="favorite-btn block rounded-xl p-2  bg-red-300  hover:bg-red-500" data-product-id="{{ product.id }}">

                {% comment %} <div class="m-2 p-2">
                    <a href="#" class="block rounded-xl p-2 bg-red-300">

                        下次再買
                    </a>
                </div> {% endcomment %}
                <div class="m-2 p-2">
                    <a href="#" class="block rounded-xl p-2 bg-red-300 hover:bg-red-500">
                        <button type="'button" data-index="{{product.id}}" id="delete-btn">刪除</button></a>
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- order-footer -->
        <div class="flex justify-between mt-2 rounded-xl p-2 bg-red-200 text-lg">
            <div class="flex flex-col justify-evenly w-1/4 p-2">
                {% comment %} <a href="#" class="bolck m-2 rounded-xl p-2 bg-gray-300">訂單下次再買</a> {% endcomment %}
                <a href="#" class="bolck m-2 rounded-xl p-2 bg-gray-300 hover:bg-red-500" id="deleteall">訂單刪除</a>
            </div>
            <div class="w-1/2 p-2">
                <!-- <div class="text-right p-2">
                    共&nbsp;
                    <span class="text-2xl font-semibold text-red-500">&nbsp;N&nbsp;</span>
                    &nbsp;項商品, 數量&nbsp;
                    <span class="text-2xl font-semibold text-red-500">&nbsp;N&nbsp;</span>
                    &nbsp;個
                </div> -->
                <br><br>
                <div class="flex justify-end text-right">
                    <div class="w-1/2 p-3">總金額</div>
                    <div class="w-1/3 p-2">
                        NT$
                        <span class="text-2xl font-semibold text-red-500">{{ totals }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- section-notice -->
    <div class="mt-12 m-2 p-2 text-center">
        <!-- notice-tag -->
        <div class="w-60 rounded-t-xl bg-red-300 p-2 text-center text-xl font-semibold text-white">
            <h3>重要提醒</h3>
        </div>
        <span class="block w-full h-1 bg-red-300"></span>
        <div class="mt-2 rounded-xl border-2 border-red-300 p-2 text-left text-lg">
            <div>
                <p>提醒一：提醒您，在購物車按下「下一步」前，請再次確認商品口味、數量、金額是否正確。</p>
            </div>
            <div>
                <p>提醒二：本站不進行商品預留，訂單成立順序以付款先後順序為準，若遇結帳時商品庫存不足導致無法購買，敬請見諒。</p>
            </div>
            <div>
                <p>提醒三：CakeCapture 保有修改商品、暫停接單、取消訂單之權利。</p>
            </div>
        </div>
    </div>
    <!-- section-redirect -->
    <div class="flex justify-end mt-12 m-2 p-2 text-center text-xl">
        <a href="{% url 'home' %}" class="block w-1/5 rounded-xl bg-gray-300 p-4">
            回首頁
        </a>
        <!-- <a href="#" class="block w-1/5 ml-4 rounded-xl bg-red-300 p-4">
            海外結帳 -->
        </a>
        <a href="{% url 'orders:order_form' %}" class="block w-1/5 ml-4 rounded-xl bg-red-300 p-4">
            國內結帳
        </a>
    </div>
</div>

<script>

    $(document).ready(function ()
    {
        // 監聽 input 元素的值變化
        $('.update').on('change', function ()
        {
            // 獲取商品 ID
            let productId = $(this).data('index');
            // 獲取數量
            let quantity = $(this).val();
            // 向後端發送 AJAX POST 請求
            $.ajax({
                type: 'POST',
                url: "{% url 'carts:update' %}",   // 替換為您的後端 URL
                data: {
                    product_id: productId,
                    product_qty: quantity,
                    csrfmiddlewaretoken: '{{ csrf_token }}',  // 如果在 Django 模板中使用，請使用模板標記獲取 CSRF token
                    action: 'post'
                },
                success: function (json)
                {
                    location.reload()
                    // 成功處理響應的操作，如果有的話
                },
                error: function (xhr, errmsg, err)
                {
                    // 處理錯誤的操作，如果有的話
                }
            });
        });
    });





    $(document).on('click', '#delete-btn', function (e)
    {
        e.preventDefault();

        $.ajax({
            type: 'POST',
            url: "{% url 'carts:delete' %}",
            data: {
                product_id: $(this).data('index'),
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },

            success: function (json)
            {
                location.reload()
            },
            error: function (xhr, errmsg, err)
            {
            }
        })
    })



    $(document).on('click', '#deleteall', function (e)
    {
        e.preventDefault();

        // 創建一個空列表，用於存儲要刪除的商品 ID
        var productsToDelete = [];

        // 遍歷所有的商品項目，如果 checkbox 被選中，則將商品 ID 添加到列表中
        const products = document.querySelectorAll(".cake")

        products.forEach((e) =>
        {
            let checkbox = e.querySelector("input")
            if (checkbox.checked)
            {
                productsToDelete.push(e.dataset.productId)
            }
        })
        console.log(productsToDelete)
        // 向後端發送 AJAX 請求，刪除所有要刪除的商品
        $.ajax({
            type: 'POST',
            url: "{% url 'carts:delete_all' %}",
            data: {
                product_ids: productsToDelete, // 將要刪除的商品 ID 作為列表傳遞給後端
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'delete-all'
            },
            success: function (json)
            {

             location.reload(); // 刷新頁面或者執行其他操作
            },
            error: function (xhr, errmsg, err)
            {
                // 處理錯誤
            }
        });
    });
    $(document).ready(function ()
        {
            $('.favorite-btn').on('click', function ()
            {
                let productId = $(this).data('product-id');
                $.ajax({
                    type: 'POST',
                    url: "{% url 'store:add_to_favorites' %}",
                    data: {
                        'product_id': productId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response)
                    {
                        if (response.status === 'added')
                        {
                            Swal.fire({
                                icon: 'success',
                                title: '商品已被加入我的最愛',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else if (response.status === 'exists')
                        {
                            Swal.fire({
                                icon: 'info',
                                title: '商品已在我的最愛中',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        }
                    }
                });
            });
        });
    

    // 獲取第一個 checkbox
    var selectAllCheckbox = document.querySelector('#firstcb');
    // 獲取所有的商品 checkbox
    var productCheckboxes = document.querySelectorAll('.cb');
    // 為第一個 checkbox 添加事件監聽器
    selectAllCheckbox.addEventListener('change', function ()
    {
        // 當第一個 checkbox 的狀態改變時，設置所有商品 checkbox 的狀態與之相同
        for (var i = 0; i < productCheckboxes.length; i++)
        {
            productCheckboxes[i].checked = this.checked;
        }
    });
</script>


{% endblock %}