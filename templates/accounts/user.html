{% extends 'shared/base.html' %}
{% load humanize %}
{% block content %}
<div class="m-auto w-screen max-w-screen-2xl" style="margin-top: 85px">
  <div x-data="{ tab: 'user-info' }">
    <nav class="bg-red-300 rounded-tl-xl rounded-tr-xl">
      <div class="mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <div class="flex items-center">
            <div class="ml-10 flex items-baseline space-x-4">
              <a href="#" @click.prevent="tab ='user-info'"
                :class="{ 'bg-red-200 text-black rounded-md px-3 py-2 text-sm font-medium': tab === 'user-info', 'text-red-800 hover:bg-red-200 hover:text-white rounded-md px-3 py-2 text-sm font-medium': tab !== 'user-info' }">
                個人資訊
              </a>

              <a href="#" id="user-bouns" @click="tab='user-bouns'" class="text-red-800 hover:bg-red-200 hover:text-white rounded-md px-3 py-2 text-sm font-medium" :class="{ 'bg-red-200 text-black': tab === 'user-bouns', 'text-red-800': tab !== 'user-bouns' }">
                商店積點
              </a>
              <a href="#" id="user-message" @click="tab='user-message'" class="text-red-800 hover:bg-red-200 hover:text-white rounded-md px-3 py-2 text-sm font-medium" :class="{ 'bg-red-200 text-black': tab === 'user-message', 'text-red-800': tab !== 'user-message' }">
                訊息
              </a>
              <a href="#" id="user-favorite" @click="tab='user-favorite'" class="text-red-800 hover:bg-red-200 hover:text-white rounded-md px-3 py-2 text-sm font-medium" :class="{ 'bg-red-200 text-black': tab === 'user-favorite', 'text-red-800': tab !== 'user-favorite' }">
                我的最愛
              </a>
              <a href="#" id="user-orderlist" @click="tab='user-orderlist'" class="text-red-800 hover:bg-red-200 hover:text-white rounded-md px-3 py-2 text-sm font-medium" :class="{ 'bg-red-200 text-black': tab === 'user-orderlist', 'text-red-800': tab !== 'user-orderlist' }">
                訂單詳情
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="user-info p-6" x-show="tab === 'user-info'">
      <h2 class="font-bold text-2xl leading-10 text-black">個人資訊</h2>
      <form action="{% url 'accounts:profile_update' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- Assuming `user_form` and `profile_form` are the context variables passed from the view -->
        {{ user_form.as_p }}
        {{ profile_form.as_p }}
        <div class="flex justify-end space-x-4">

          <button type="reset"
            class="rounded-md bg-red-300 px-8 py-3 text-sm font-medium text-red-800 hover:bg-red-200 hover:text-white">取消</button>
          <button type="submit"
            class="rounded-md bg-red-300 px-8 py-3 text-sm font-medium text-red-800 hover:bg-red-200 hover:text-white">儲存變更</button>
        </div>

      </form>

    </div>
    <div class="user-bouns p-6" x-show="tab === 'user-bouns'">
      <h2 class="font-bold text-2xl leading-10 text-black">商店積點</h2>
      <div class="m-3 flex justify-evenly">
        <h3 class="font-bold text-l leading-10 text-gray-600">目前點數</h3>
        <p class="font-medium text-m leading-10 text-gray-600">Num</p>
      </div>
      <div class="pt-6">
        <table class="w-full table-auto shadow-md">
          <tr class="border-b border-gray-900/10 pb-12">
            <th class="text-md px-6 py-3">日期</th>
            <th class="text-md px-6 py-3">項目</th>
            <th class="text-md px-6 py-3">回饋金額</th>
            <th class="text-md px-6 py-3">到期日</th>
            <th class="text-md px-6 py-3">餘額</th>
          </tr>
          <tr>
            <td class="text-md px-6 py-3">內容一</td>
            <td class="text-md px-6 py-3">內容二</td>
            <td class="text-md px-6 py-3">內容三</td>
            <td class="text-md px-6 py-3">內容四</td>
            <td class="text-md px-6 py-3">內容五</td>
          </tr>
          <tr>
            <td class="text-md px-6 py-3">內容一</td>
            <td class="text-md px-6 py-3">內容二</td>
            <td class="text-md px-6 py-3">內容三</td>
            <td class="text-md px-6 py-3">內容四</td>
            <td class="text-md px-6 py-3">內容五</td>
          </tr>
        </table>
      </div>
    </div>

    <div class="user-message p-6" x-show="tab === 'user-message'">
      <h2 class="font-bold text-2xl leading-10 text-black">訊息</h2>
      <div class="">
        <div class="flex justify-evenly items-start bg-white rounded-lg p-4 shadow">
          <form
            action="{% url 'feedbacks:create' %}"
            method="post"
            class="pt-10"
          >
            {% csrf_token %}
            <div>
              <label>留言：</label><br />
              <textarea
                name="mytext"
                rows="6"
                cols="40"
                required
                class="border bg-red-200"
              ></textarea>
            </div>
            <div class="mt-6">
              <button
                type="reset"
                class="inline-block rounded-md border border-transparent bg-red-300 px-8 py-3 text-center text-sm font-medium text-red-800 hover:text-white hover:bg-red-200"
              >
                取消
              </button>
              <button
                type="submit"
                class="inline-block rounded-md border border-transparent bg-red-300 px-8 py-3 text-center text-sm font-medium text-red-800 hover:text-white hover:bg-red-200"
              >
                儲存變更
              </button>
            </div>
          </form>
    
          <div class="justify-center mt-4 rounded-lg p-4 flex-col m-4 bg-left">
            {% for comment in comments %}
            <div class="ml-10 shadow w-64 m-2.5 font-mono text-gray-600">
              <p>帳號:{{comment.user}}</p>
              <p>內容:{{comment.message}}</p>
              <p>{{comment.add_time}}</p>
              <br />
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="user-favorite p-6" x-show="tab === 'user-favorite'">
      <h2 class="font-bold text-2xl leading-10 text-black">我的最愛</h2>
      <div class="w-full max-w-screen-lg mx-auto">
        <div class="">
          <section>
            <div class="container-3xl mx-auto">
              <div class="flex flex-wrap gap-6">
								{% if favorites %}
                {% for favorite in favorites %}
                <!-- card -->
                <div
                  class="card relative flex w-full min-w-[15rem] max-w-[20rem] flex-col rounded-xl bg-white bg-clip-border text-gray-700 shadow-lg hover:scale-105 transition ease-in duration-300">
                  <div
                    class="relative mx-4 mt-4 overflow-hidden rounded-xl bg-blue-gray-500 bg-clip-border text-white shadow-lg shadow-blue-gray-500/40">
                    <img src="{{ favorite.product.image.url }}" class="w-full h-[288px] object-cover" />
                    <!-- delete -->
                    <button
                      class="delete-favorite-btn !absolute top-4 right-4 h-8 max-h-[32px] w-8 max-w-[32px] bg-white/70 select-none rounded-lg text-center align-middle text-xs font-medium text-red-500 transition-all hover:bg-white/90 active:bg-red-500/30"
                      type="button" data-index="{{favorite.product.id}}" data-ripple-dark="true">
                      <i class="fa-regular fa-trash-can" style="transform: scale(1.5);"></i>
                    </button>
                  </div>
                  <a href="{% url 'products:detail' favorite.product.id %}">
                    <div class="p-6">
                      <div class="mb-3 flex items-center justify-between">
                        <!-- 產品名稱 -->
                        <h5 class="block text-xl font-bold leading-snug tracking-normal text-blue-gray-900 antialiased">
                          {{ favorite.product.name }}
                        </h5>
                      </div>
                      <div class="flex items-center justify-between">
                        <!-- 產品價格 -->
                        <p class="block text-base font-bold text-blue-500">$ {{ favorite.product.price }}</p>
                      </div>
                    </div>
                  </a>
                </div>
								{% endfor %}
								{% else %}
                <p>你還沒有收藏任何商品。</p>
								{% endif %}
              </div>
            </div>
          </section>
          <div class="additional-box"></div>
          <div class="chat-widget"></div>
        </div>
      </div>
    </div>

    <div class="user-orderlist p-6" x-show="tab === 'user-orderlist'">
      <h2 class="font-bold text-2xl leading-10 text-black">訂單詳情</h2>
      <div class="pt-6" x-data="{ open: false }">
        {% if orders %}
        <table class="w-full table-auto shadow-md">
          <tr class="border-b border-gray-900/10 pb-12">
            <th class="text-md px-6 py-3">訂單號碼</th>
            <th class="text-md px-6 py-3">訂購日期</th>
            <th class="text-md px-6 py-3">訂單金額</th>
            <th class="text-md px-6 py-3">訂單狀況</th>
            <th class="text-md px-6 py-3"></th>
          </tr>
<!-- 渲染訂單start -->
          {% for order in orders %}
          <tr x-data="{ open:false }">
            <td class="text-md px-6 py-3">{{ order.order_id }}</td>
            <td class="text-md px-6 py-3">{{ order.created }}</td>
            <td class="text-md px-6 py-3">$ {{ order.total|intcomma }}</td>
            <td class="text-md px-6 py-3">{{ order.status }}</td>
            <td class="text-md px-6 py-3">
              <button @click="open = !open" class="inline-block rounded-md border border-transparent bg-red-800 px-8 py-3 text-center text-sm font-medium text-white hover:text-black hover:bg-red-200">
                訂單細節
              </button>
              <div x-show="open" class="fixed z-10 inset-0 overflow-y-auto" aria-labelledby="order-detail-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                  <!-- 背景遮罩 -->
                  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="open = false"></div>
                  <!-- 模態框容器 -->
                  <div class="my-28 inline-block align-middle bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-7xl sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                      <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                          <h3 class="text-lg leading-6 font-medium text-gray-900" id="order-detail-title">
                            訂單編號：{{ order.order_id }}
                          </h3>
                          <div class="flex mt-2 p-2 bg-red-200 text-xl font-semibold rounded-xl">
                            <div class="w-5/12 p-2">
                              <p>商品明細</p>
                            </div>
                            <div class="w-2/12 p-2 border-l-2 border-red-400">
                              <p>類別</p>
                            </div>
                            <div class="w-1/12 p-2 border-l-2 border-red-400">
                              <p>單價</p>
                            </div>
                            <div class="w-1/12 p-2 border-l-2 border-red-400">
                              <p>數量</p>
                            </div>
                            <div class="w-1/12 p-2 border-l-2 border-red-400">
                              <p>總價</p>
                            </div>
                            <div class="w-2/12 p-2 border-l-2 border-red-400">
                            </div>
                          </div>
                          <!-- order list -->

                          <div class="order-list">
                            {% for item in order.orderitem_set.all %}
                            <div class="flex mt-2 p-2 h-52 rounded-xl text-xl border-2 border-red-300 cake" data-product-id="{{ item.product.id }}">
                              <div class="flex w-5/12 p-2">
                                <div class="product-img rounded-2xl w-[180px] h-[180px] overflow-hidden">
                                  <img src="{{ item.product.image.url }}" alt="#" class="w-full h-full object-cover">
                                </div>
                                <div class="felx flex-col m-auto w-1/2 p-2">
                                  <p>{{ item.product.name }}</p>
                                </div>
                              </div>
                              <div class="felx flex-col m-auto w-2/12 p-2">
                                <p>{{ item.product.category.name }}</p>
                              </div>
                              <div class="felx flex-col m-auto w-1/12 p-2">
                                <p>${{ item.price }}</p>
                              </div>
                              <div class="felx flex-col m-auto w-1/12 p-2">
                                <p>{{ item.quantity }}</p>
                              </div>
                              <div class="felx flex-col m-auto w-1/12 p-2">
                                <p>$ {{ item.item_total }}</p>
                              </div>
                              <div class="flex flex-col m-auto w-2/12 p-2 items-center justify-center">
                                <div class="m-2 p-2">
                                  <a href="#" class="block rounded-xl p-2 bg-red-300 hover:bg-red-500 flex items-center justify-center">
                                    <button type="'button" data-index="{{product.id}}" id="rebuy-btn" class="text-center">再買一次</button></a>
                                </div>
                              </div>
                            </div>
                            {% endfor %}
                          </div>
                          <!-- detail list -->
                          <div class="mt-2">
                            <div class="flex justify-center">
                              <div class="bg-white shadow-lg rounded-lg overflow-hidden w-full">
                                <div class="md:flex">
                                    <!-- 收件信息 -->
                                  <div class="md:w-1/2 p-5">
                                    <h3 class="text-lg font-semibold text-gray-700">收件資訊</h3>
                                    <p class="mt-2 text-gray-600"><strong>購買人:</strong> {{ order.ordermethod.order_name }}</p>
                                    <p class="mt-2 text-gray-600"><strong>電郵:</strong> {{ order.email }}</p>
                                    <p class="mt-2 text-gray-600"><strong>電話:</strong> {{ order.phone }}</p>
                                    <p class="mt-2 text-gray-600"><strong>收件人姓名:</strong> {{ order.name }}</p>
                                    <p class="mt-2 text-gray-600"><strong>收件人電話:</strong> {{ order.phone }}</p>
                                    <p class="mt-2 text-gray-600"><strong>收件人電郵:</strong> {{ order.email }}</p>
                                    <p class="mt-2 text-gray-600"><strong>收件地址:</strong> {{ order.address }}</p>
                                  </div>
                                  <!-- 購買信息 -->
                                  <div class="md:w-1/2 p-5 border-l-2 border-gray-200">
                                    <h3 class="text-lg font-semibold text-gray-700">購買資訊</h3>
                                    <p class="mt-2 text-gray-600"><strong>總金額:</strong> ${{ order.total|intcomma }}</p>
                                    <p class="mt-2 text-gray-600"><strong>訂單成立時間:</strong> {{ order.created|date:"Y-m-d H:i" }}</p>
                                    <p class="mt-2 text-gray-600"><strong>目前訂單狀態:</strong> {{ order.get_status_display }}</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>  
                      </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                      <button @click="open = false" type="button" class="inline-block rounded-md border border-transparent bg-red-800 px-8 py-3 text-center text-sm font-medium text-white hover:text-black hover:bg-red-200">
                        關閉
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <div class="text-center py-10">
          <p class="text-xl font-bold">目前您尚未訂購任何產品</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  $(document).on('click', '.delete-favorite-btn', function (e){
    e.preventDefault();
    card = this.closest('.card')
    product_id = $(this).data('index')
  
    $.ajax({
      type: 'POST',
      url: "{% url 'accounts:favorite_delete' %}",
      data: {
        product_id: $(this).data('index'),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function (json){
        card.remove()       
      },
      error: function (xhr, errmsg, err){
      }
    })
  })

</script>

{% endblock %}